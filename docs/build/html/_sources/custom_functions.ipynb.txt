{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "3a87f67d",
   "metadata": {},
   "source": [
    "# üõ†Ô∏è Creating Custom Symbolic Functions\n",
    "\n",
    "Featuristic supports a rich set of **built-in symbolic functions** (e.g., `add`, `log`, `sqrt`, `sin`), but you can easily **define and register your own**.\n",
    "\n",
    "This allows you to inject domain knowledge, constrain the search space, or explore creative transformations that go beyond generic math.\n",
    "\n",
    "---\n",
    "\n",
    "## üß± What Is a Symbolic Function?\n",
    "\n",
    "A symbolic function is a mathematical operator that can be used to build symbolic expressions. Each one has:\n",
    "\n",
    "- A **name** (str)\n",
    "- An **arity** (number of arguments)\n",
    "- A **format** string (how to render the expression)\n",
    "- A **callable** (NumPy/pandas-compatible implementation)\n",
    "\n",
    "---\n",
    "\n",
    "## ‚úçÔ∏è Defining a Custom Function\n",
    "\n",
    "Use `define_symbolic_function()` to define your own:\n",
    "\n",
    "```python\n",
    "from featuristic import define_symbolic_function\n",
    "\n",
    "# Define a safe inverse transformation\n",
    "inv = define_symbolic_function(\n",
    "    name=\"inv\",\n",
    "    arity=1,\n",
    "    format_str=\"1/({})\",\n",
    "    func=lambda x: 1 / (x + 1e-5)\n",
    ")\n",
    "```\n",
    "\n",
    "- `name`: How the function will be identified internally\n",
    "- `arity`: Number of arguments the function takes\n",
    "- `format_str`: How it appears in the rendered formula ({} for each argument)\n",
    "- `func`: A NumPy-compatible function that operates on arrays or Series\n",
    "\n",
    "---\n",
    "\n",
    "## ‚úÖ Using It in Genetic FeatureSynthesis\n",
    "\n",
    "Once defined, pass the function to your synthesis instance:\n",
    "\n",
    "```python\n",
    "gfs = GeneticFeatureSynthesis(\n",
    "    custom_functions=[inv],\n",
    "    num_features=5,\n",
    "    max_generations=30\n",
    ")\n",
    "```\n",
    "\n",
    "Custom functions can be combined with built-in ones, or you can restrict your search space by only using the functions you specify.\n",
    "\n",
    "---\n",
    "\n",
    "## üì¶ Example: Clipped Log Function\n",
    "\n",
    "Here‚Äôs an example that avoids domain errors by clipping small values:\n",
    "\n",
    "```python\n",
    "safe_log = define_symbolic_function(\n",
    "    name=\"log1p_clip\",\n",
    "    arity=1,\n",
    "    format_str=\"log1p_clip({})\",\n",
    "    func=lambda x: np.log1p(np.clip(x, 1e-5, None))\n",
    ")\n",
    "\n",
    "gfs = GeneticFeatureSynthesis(custom_functions=[safe_log])\n",
    "```\n",
    "\n",
    "---\n",
    "\n",
    "## üîç Tips for Writing Safe Functions\n",
    "\n",
    "Symbolic functions may be evaluated on raw, messy data. To avoid NaN, inf, or crashes:\n",
    "\n",
    "- Use `np.clip`, `np.where`, or `.replace()` to handle edge cases\n",
    "- Avoid division by zero\n",
    "- Always test your function on arrays and pandas.Series\n",
    "\n",
    "---\n",
    "\n",
    "## üß† Advanced: Pre-registering Functions\n",
    "\n",
    "You can also globally register your function using the `@register_symbolic_function` decorator:\n",
    "\n",
    "```python\n",
    "from featuristic import register_symbolic_function\n",
    "\n",
    "@register_symbolic_function(name=\"cube_root\", arity=1, fmt=\"cbrt({})\")\n",
    "def cube_root(x):\n",
    "    return np.cbrt(x)\n",
    "```\n",
    "\n",
    "Now \"cube_root\" is available globally via:\n",
    "\n",
    "```python\n",
    "GeneticFeatureSynthesis(functions=[\"cube_root\"])\n",
    "```\n",
    "\n",
    "## üìÉ Built-in Examples\n",
    "\n",
    "| Name                 | Arity | Description                 |\n",
    "| -------------------- | ----- | --------------------------- |\n",
    "| `add`                | 2     | Addition                    |\n",
    "| `subtract`           | 2     | Subtraction                 |\n",
    "| `multiply`           | 2     | Multiplication              |\n",
    "| `divide`             | 2     | Safe division with fallback |\n",
    "| `log`                | 1     | Safe log with clipping      |\n",
    "| `sin`, `cos`, `sqrt` | 1     | Standard math functions     |\n",
    "| `clip`               | 3     | Bounded transformation      |\n",
    "| `square`, `cube`     | 1     | Power transforms            |\n",
    "\n",
    "Use `featuristic.list_symbolic_functions()` to see available ones.\n",
    "\n",
    "---\n",
    "\n",
    "## ‚úÖ Summary\n",
    "\n",
    "| Concept                       | Description                           |\n",
    "| ----------------------------- | ------------------------------------- |\n",
    "| `define_symbolic_function()`  | Define symbolic ops dynamically       |\n",
    "| `custom_functions=[...]`      | Add your own functions to synthesis   |\n",
    "| `format_str`                  | Controls how expressions are rendered |\n",
    "| `@register_symbolic_function` | Register global reusable ops          |\n"
   ]
  }
 ],
 "metadata": {
  "language_info": {
   "name": "python"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
